<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XML → IP CSV Converter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f4f5f7; color:#222; padding:20px; }
    .container{max-width:960px;margin:40px auto;padding:0 16px;}
    .card{background:#fff;border-radius:8px;padding:24px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
    h1{margin-top:0;font-size:1.6rem;}
    .dropzone{border:2px dashed #ccc;border-radius:6px;padding:24px;text-align:center;margin-bottom:8px;background:#fafafa;min-height:80px;display:flex;align-items:center;justify-content:center;flex-direction:column;}
    textarea{width:100%;min-height:160px;resize:vertical;padding:10px;border-radius:4px;border:1px solid #ccc;font-family:monospace;font-size:0.85rem;}
    button{background:#0077ff;color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;font-weight:500;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    table{border-collapse:collapse;width:100%;font-family:monospace;font-size:0.85rem;margin-top:12px;}
    td,th{border-bottom:1px solid #eee;padding:6px;}
    .status{margin-top:8px;font-size:0.85rem;min-height:18px;}
    .status.error{color:#c0392b;}
    .status.success{color:#2c7a3f;}
    .status.info{color:#555;}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:0.8rem;background:#e8f2ff;color:#004b9a;margin-left:8px;}
  </style>
</head>
<body>
<div class="container">
<div class="card">
  <h1>XML → IP CSV Converter</h1>

  <div class="dropzone" id="dropzone">
    Drag &amp; drop file XML di sini<br />
    <span style="font-size:0.8rem;color:#666;">(prioritas tertinggi jika digunakan)</span>
  </div>

  <input id="fileInput" type="file" accept=".xml,text/xml"/>
  <textarea id="xmlTextarea" placeholder="Paste isi XML di sini jika tidak menggunakan file..."></textarea>
  <br/><br/>

  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <button id="convertBtn">Convert to CSV</button>
    <button id="downloadBtn" disabled>Download CSV</button>
    <button id="copyBtn" disabled>Copy hasil ke Clipboard</button>
    <span id="loadingIndicator" class="status info"></span>
  </div>

  <div id="statusMessage" class="status"></div>

  <div id="resultsSection" style="display:none;">
    <h3>Ditemukan <span id="ipCount">0</span> IP unik <span class="badge" id="sourceInfo"></span></h3>
    <table>
      <thead><tr><th>IP Address</th></tr></thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

</div></div>
</div>

<script>
(function(){
const dz = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const xmlTextarea = document.getElementById('xmlTextarea');
const convertBtn = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const copyBtn = document.getElementById('copyBtn');
const statusMessage = document.getElementById('statusMessage');
const resultsSection = document.getElementById('resultsSection');
const resultsBody = document.getElementById('resultsBody');
const ipCountEl = document.getElementById('ipCount');
const sourceInfoEl = document.getElementById('sourceInfo');
const loadingEl = document.getElementById('loadingIndicator');

let droppedXml = null;
let droppedName = null;

// Drag & Drop File Reader
dz.addEventListener('dragover', e=>{
  e.preventDefault();
  dz.style.borderColor = '#0077ff';
});
dz.addEventListener('dragleave', e=>{
  e.preventDefault();
  dz.style.borderColor = '#ccc';
});
dz.addEventListener('drop', e=>{
  e.preventDefault();
  dz.style.borderColor = '#ccc';
  const file = e.dataTransfer.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    droppedXml = ev.target.result;
    droppedName = file.name;
    dz.innerHTML = `<strong>File "${droppedName}" dari drag &amp; drop sudah dimuat. Siap di-convert. Klik Convert to CSV</strong>`;
  };
  reader.readAsText(file);

  setStatus(`File "${file.name}" berhasil masuk. Klik Convert to CSV untuk melanjutkan.`);
});

// Convert & CSV Export
convertBtn.addEventListener('click', ()=>{
  clearResults();
  const xml = xmlTextarea.value.trim() || droppedXml;
  const label = droppedName ? 'Drag & drop file ('+droppedName+')' : 'Textarea';
  if(!xml){ setStatus('Tidak ada XML input','error'); return; }

  try{
    const ips = parseIps(xml);
    lastIps = ips;
    renderIps(ips, label);
    downloadBtn.disabled = false;
    copyBtn.disabled = false;
    setLoading('');
    setStatus('Convert berhasil ✅. IP siap di-download atau di-copy','success');
  }catch(e){
    setStatus('Error: '+e.message,'error');
    setLoading('');
  }
});

// Download CSV
downloadBtn.addEventListener('click', ()=>{
  if(!lastIps.length) return;
  const csv = ['IP Address',...lastIps].join('\\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'export_ips.csv';
  a.click();
  URL.revokeObjectURL(url);
});

// Copy to Clipboard
copyBtn.addEventListener('click', ()=>{
  if(!lastIps.length) return;
  const text = ['IP Address',...lastIps].join('\\n');
  navigator.clipboard.writeText(text)
    .then(()=> setStatus('IP copied to clipboard ✅. Paste ke Excel sekarang.','success'))
    .catch(()=> setStatus('Gagal copy','error'));
});

// Helpers
function setStatus(msg, type='info'){
  statusMessage.innerHTML = `<strong>${msg}</strong>`;
  statusMessage.className = 'status '+type;
}
function setLoading(msg){ loadingEl.textContent = msg; }
function setLoading(msg){ dz.innerHTML = `<strong>${msg}</strong>`; }
function renderIps(l){
  dz.innerHTML = `<strong>File "${droppedName}" dari upload sudah dimuat ✅. Klik Convert to CSV</strong>`;
}

// Parsing XML → Base64 → PHP-unserialize → IP expand
function parseIps(xmlString){
  const doc = new DOMParser().parseFromString(xmlString,'application/xml');
  const def = doc.getElementsByTagName('definition')[0];
  if(!def) throw new Error('Tag <definition> tidak ditemukan');
  let ser;
  try{ ser = atob(def.textContent.trim()); }catch(e){ throw new Error('Base64 invalid');}
  const o = phpUnserialize(ser);
  const ipStr = o.definedIPs || o['definedIPs'];
  if(!ipStr) throw new Error('Key definedIPs tidak ditemukan');
  const set = new Set();
  for(const i of ipStr.split(',')){
    const v=i.trim(); if(!v) continue;
    if(v.includes('-')) expandRange(v,set);
    else if(v.includes('/')) expandCidr(v,set);
    else if(isValidIp(v)) set.add(v);
  }
  return [...set];
}

function isValidIp(ip){ return /^\\d+\\.\\d+\\.\\d+\\.\\d+$/.test(ip) && ip.split('.').every(o=>o>=0&&o<=255); }
function ipToInt(ip){return ip.split('.').reduce((n,p)=>n*256+ +p,0);}
function intToIp(n){return[(n>>>24)&255,(n>>>16)&255,(n>>>8)&255,n&255].join('.');}
function estimateRangeSize(r){const[a,b]=r.split('-').map(s=>s.trim());return Math.abs(ipToInt(b)-ipToInt(a))+1;}
function estimateCidrSize(c){const[i,p]=c.split('/');return Math.pow(2,32-p);}

// Expand range
function expandRange(r,set){let[a,b]=r.split('-').map(s=>s.trim());let s=ipToInt(a),e=ipToInt(b);if(e<s)[s,e]=[e,s];for(let i=s;i<=e;i++)set.add(intToIp(i));}

// Expand CIDR
function expandCidr(c,set){const[ip,p]=c.split('/');const n=ipToInt(ip.trim());const h=Math.pow(2,32-+p.trim());const m=~(h-1)>>>0;const b=n&m;for(let i=0;i<h;i++)set.add(intToIp(b+i));}

// PHP unserialize parser minimal
function php(data){ let i=0;
  const r=()=>{ const t=data[i++]; if(t==='N'){i++;return null;}
    if(t==='i'){i++;const n=parseInt(data.slice(i,data.indexOf(';',i))); i=data.indexOf(';',i)+1; return n;}
    if(t==='s'){i++;const l=parseInt(data.slice(i,data.indexOf(':',i))); i=data.indexOf(':',i)+2; const s=data.substr(i,l); i+=l+2; return s;}
    if(t==='a'){i++;const c=parseInt(data.slice(i,data.indexOf(':',i))); i=data.indexOf(':',i)+2; const o={};
      for(let k=0;k<c;k++){ const K=r(),V=r(); o[K]=V; } i++; return o; }
  }; return r(); }
  return r(); }

})();
</script>
</body>
</html>
